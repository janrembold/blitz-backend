#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("source-map-support/register");
const cdk = require("@aws-cdk/core");
const dotenv = require("dotenv");
const vpc_stack_1 = require("../lib/vpc-stack");
const rds_stack_1 = require("../lib/rds-stack");
const lambda_stack_1 = require("../lib/lambda-stack");
const api_gateway_stack_1 = require("../lib/api-gateway-stack");
dotenv.config();
console.log('AWS Account', process.env.AWS_ACCOUNT_NUMBER);
const stage = process.env.STAGE || 'local';
const app = new cdk.App();
const vpcStack = new vpc_stack_1.VpcStack(app, 'VpcStack');
const dbStack = new rds_stack_1.RDSStack(app, 'RDSStack', {
    vpc: vpcStack.vpc,
    stage
});
const postgraphileLambdaStack = new lambda_stack_1.LambdaStack(app, 'PostgraphileExpress', {
    handler: 'postgraphile/index.express',
    vpc: vpcStack.vpc,
    stage,
    environment: {
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
        SECRET_ARN: dbStack.secret.secretArn,
        DB_NAME: dbStack.databaseName,
        DB_HOST: dbStack.postgresInstance.dbInstanceEndpointAddress,
        DB_PORT: dbStack.postgresInstance.dbInstanceEndpointPort,
    }
});
new api_gateway_stack_1.ApiGatewayStack(app, 'ApiGatewayStack', {
    handler: postgraphileLambdaStack.lambda,
    vpc: vpcStack.vpc,
    stage
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2RrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHVDQUFxQztBQUNyQyxxQ0FBcUM7QUFDckMsaUNBQWlDO0FBQ2pDLGdEQUE0QztBQUM1QyxnREFBNEM7QUFDNUMsc0RBQWtEO0FBQ2xELGdFQUEyRDtBQUUzRCxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBRTNELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLE9BQU8sQ0FBQztBQUUzQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxQixNQUFNLFFBQVEsR0FBSSxJQUFJLG9CQUFRLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRWhELE1BQU0sT0FBTyxHQUFHLElBQUksb0JBQVEsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFO0lBQzVDLEdBQUcsRUFBRSxRQUFRLENBQUMsR0FBRztJQUNqQixLQUFLO0NBQ04sQ0FBQyxDQUFDO0FBRUgsTUFBTSx1QkFBdUIsR0FBRyxJQUFJLDBCQUFXLENBQUMsR0FBRyxFQUFFLHFCQUFxQixFQUFFO0lBQzFFLE9BQU8sRUFBRSw0QkFBNEI7SUFDckMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxHQUFHO0lBQ2pCLEtBQUs7SUFDTCxXQUFXLEVBQUU7UUFDWCxtQ0FBbUMsRUFBRSxHQUFHO1FBQ3hDLFVBQVUsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVM7UUFDcEMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxZQUFZO1FBQzdCLE9BQU8sRUFBRSxPQUFPLENBQUMsZ0JBQWdCLENBQUMseUJBQXlCO1FBQzNELE9BQU8sRUFBRSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsc0JBQXNCO0tBQ3pEO0NBQ0YsQ0FBQyxDQUFDO0FBRUgsSUFBSSxtQ0FBZSxDQUFDLEdBQUcsRUFBRSxpQkFBaUIsRUFBRTtJQUMxQyxPQUFPLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtJQUN2QyxHQUFHLEVBQUUsUUFBUSxDQUFDLEdBQUc7SUFDakIsS0FBSztDQUNOLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcbmltcG9ydCAnc291cmNlLW1hcC1zdXBwb3J0L3JlZ2lzdGVyJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCAqIGFzIGRvdGVudiBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IHsgVnBjU3RhY2sgfSBmcm9tICcuLi9saWIvdnBjLXN0YWNrJztcbmltcG9ydCB7IFJEU1N0YWNrIH0gZnJvbSAnLi4vbGliL3Jkcy1zdGFjayc7XG5pbXBvcnQgeyBMYW1iZGFTdGFjayB9IGZyb20gJy4uL2xpYi9sYW1iZGEtc3RhY2snO1xuaW1wb3J0IHsgQXBpR2F0ZXdheVN0YWNrIH0gZnJvbSAnLi4vbGliL2FwaS1nYXRld2F5LXN0YWNrJztcblxuZG90ZW52LmNvbmZpZygpO1xuY29uc29sZS5sb2coJ0FXUyBBY2NvdW50JywgcHJvY2Vzcy5lbnYuQVdTX0FDQ09VTlRfTlVNQkVSKTtcblxuY29uc3Qgc3RhZ2UgPSBwcm9jZXNzLmVudi5TVEFHRSB8fCAnbG9jYWwnO1xuXG5jb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuY29uc3QgdnBjU3RhY2sgID0gbmV3IFZwY1N0YWNrKGFwcCwgJ1ZwY1N0YWNrJyk7XG5cbmNvbnN0IGRiU3RhY2sgPSBuZXcgUkRTU3RhY2soYXBwLCAnUkRTU3RhY2snLCB7XG4gIHZwYzogdnBjU3RhY2sudnBjLFxuICBzdGFnZVxufSk7XG5cbmNvbnN0IHBvc3RncmFwaGlsZUxhbWJkYVN0YWNrID0gbmV3IExhbWJkYVN0YWNrKGFwcCwgJ1Bvc3RncmFwaGlsZUV4cHJlc3MnLCB7XG4gIGhhbmRsZXI6ICdwb3N0Z3JhcGhpbGUvaW5kZXguZXhwcmVzcycsXG4gIHZwYzogdnBjU3RhY2sudnBjLFxuICBzdGFnZSxcbiAgZW52aXJvbm1lbnQ6IHtcbiAgICBBV1NfTk9ERUpTX0NPTk5FQ1RJT05fUkVVU0VfRU5BQkxFRDogJzEnLFxuICAgIFNFQ1JFVF9BUk46IGRiU3RhY2suc2VjcmV0LnNlY3JldEFybixcbiAgICBEQl9OQU1FOiBkYlN0YWNrLmRhdGFiYXNlTmFtZSwgXG4gICAgREJfSE9TVDogZGJTdGFjay5wb3N0Z3Jlc0luc3RhbmNlLmRiSW5zdGFuY2VFbmRwb2ludEFkZHJlc3MsXG4gICAgREJfUE9SVDogZGJTdGFjay5wb3N0Z3Jlc0luc3RhbmNlLmRiSW5zdGFuY2VFbmRwb2ludFBvcnQsXG4gIH0gXG59KTtcblxubmV3IEFwaUdhdGV3YXlTdGFjayhhcHAsICdBcGlHYXRld2F5U3RhY2snLCB7XG4gIGhhbmRsZXI6IHBvc3RncmFwaGlsZUxhbWJkYVN0YWNrLmxhbWJkYSxcbiAgdnBjOiB2cGNTdGFjay52cGMsXG4gIHN0YWdlXG59KTsiXX0=